<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1〜43 抽選（重複なし6個）</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 20px; }
    .box { max-width: 720px; margin: 0 auto; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    h2 { font-size: 16px; margin: 0 0 10px; }
    .result { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 28px; font-weight: 700; padding: 12px 0; }
    button { padding: 10px 14px; margin-right: 10px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { text-align: left; background: #f6f6f6; }
    .muted { color: #666; font-size: 12px; margin-top: 6px; }
    #statsBox { border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    #debug { margin-top: 10px; font-size: 12px; color: #b00; white-space: pre-wrap; }
    hr { margin: 20px 0; }
  </style>
</head>
<body>
  <div class="box">
    <h1>1〜43から重複なしで6個を抽選（履歴保存あり）</h1>

    <div class="result" id="result">—</div>

    <div>
      <label style="display:inline-block;margin-right:10px;">
        <input type="checkbox" id="weightedMode">
        頻度重み付け抽選（偏り）
      </label>

      <button id="draw">抽選する</button>
      <button id="copy">コピー</button>
      <button id="export">履歴をCSV出力</button>
      <button id="clear">履歴を消去</button>
    </div>

    <div class="muted">
      履歴はこの端末内に保存されます（localStorage）。端末を変えると引き継がれません。
    </div>

    <div id="debug"></div>

    <hr>

    <h2>過去データ統計（loto6_stats.json）</h2>
    <div id="statsBox">
      <div id="statsStatus" class="muted">統計データを読み込み中…</div>

      <div style="margin-top:10px;">
        <div><b>対象回数</b>: <span id="s_draws">—</span></div>
        <div><b>対象期間</b>: <span id="s_range">—</span></div>
        <div><b>連番（差=1）が1組以上ある確率</b>: <span id="s_consecutive_any">—</span></div>
        <div><b>連番ペア数分布（0〜4）</b>: <span id="s_consecutive_dist">—</span></div>
      </div>

      <div style="margin-top:12px;">
        <b>本数字 出現回数 Top10</b>
        <ol id="s_top10" style="margin:8px 0 0 18px;"></ol>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>日時</th>
          <th>結果（昇順）</th>
        </tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
  </div>

<script>
  const KEY = "lottery_history_v1";
  let loto6Stats = null;

  function dbg(msg){
    const el = document.getElementById("debug");
    if(el) el.textContent += msg + "\n";
  }

  window.onerror = function(message, source, lineno, colno){
    dbg(`JSエラー: ${message}\n${source}:${lineno}:${colno}`);
  };

  function pad2(n){ return String(n).padStart(2, "0"); }

  function pickUniqueNumbers(){
    const nums = new Set();
    while(nums.size < 6){
      nums.add(Math.floor(Math.random() * 43) + 1);
    }
    return Array.from(nums).sort((a,b)=>a-b);
  }

  function nowTimestamp(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    const ss = pad2(d.getSeconds());
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  function loadHistory(){
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  }

  function saveHistory(items){
    localStorage.setItem(KEY, JSON.stringify(items));
  }

  function render(){
    const items = loadHistory();
    const tbody = document.getElementById("history");
    tbody.innerHTML = "";
    for(const it of items.slice().reverse()){
      const tr = document.createElement("tr");
      const td1 = document.createElement("td");
      const td2 = document.createElement("td");
      td1.textContent = it.ts;
      td2.textContent = it.nums.map(pad2).join(" ");
      tr.appendChild(td1);
      tr.appendChild(td2);
      tbody.appendChild(tr);
    }
  }

  async function loadLoto6Stats(){
    const status = document.getElementById("statsStatus");

    try{
      const res = await fetch("./loto6_stats.json?v=2", { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const stats = await res.json();
      loto6Stats = stats;

      const sum = stats.summary || {};
      document.getElementById("s_draws").textContent = sum.draws ?? "—";
      document.getElementById("s_range").textContent =
        (sum.date_min && sum.date_max) ? `${sum.date_min} .. ${sum.date_max}` : "—";

      const p = sum.consecutive_any_ratio;
      document.getElementById("s_consecutive_any").textContent =
        (typeof p === "number") ? `${(p*100).toFixed(2)}%` : "—";

      const dist = sum.consecutive_pairs_distribution || {};
      const keys = Object.keys(dist).sort((a,b)=>Number(a)-Number(b));
      document.getElementById("s_consecutive_dist").textContent =
        keys.length ? keys.map(k => `${k}組:${dist[k]}回`).join(" / ") : "—";

      const top10 = stats.top10_main || [];
      const ol = document.getElementById("s_top10");
      ol.innerHTML = "";
      for(const [num, cnt] of top10){
        const li = document.createElement("li");
        li.textContent = `${num}（${cnt}回）`;
        ol.appendChild(li);
      }

      status.textContent = "統計データの読み込み完了";
    }catch(e){
      status.textContent = `統計データの読み込みに失敗: ${e.message}`;
      dbg("統計ロード失敗: " + e.message);
    }
  }

  function weightedChoiceIndex(weights){
    let total = 0;
    for(const w of weights) total += w;
    let r = Math.random() * total;
    for(let i = 0; i < weights.length; i++){
      r -= weights[i];
      if(r <= 0) return i;
    }
    return weights.length - 1;
  }

  function weightedPickNumbersFromStats(){
    if(!loto6Stats || !loto6Stats.freq_main){
      throw new Error("統計データ（loto6_stats.json）が未読込です。");
    }

    const freq = loto6Stats.freq_main;
    const items = [];
    const weights = [];
    for(let n = 1; n <= 43; n++){
      items.push(n);
      const w = (Number(freq[n]) || 0) + 1; // 0重み回避
      weights.push(w);
    }

    const picked = [];
    for(let k = 0; k < 6; k++){
      const idx = weightedChoiceIndex(weights);
      picked.push(items[idx]);
      items.splice(idx, 1);
      weights.splice(idx, 1);
    }

    picked.sort((a,b)=>a-b);
    return picked;
  }

  document.addEventListener("DOMContentLoaded", () => {
    dbg("起動: DOMContentLoaded");

    document.getElementById("draw").addEventListener("click", () => {
      let nums;
      const weighted = document.getElementById("weightedMode").checked;

      try{
        nums = weighted ? weightedPickNumbersFromStats() : pickUniqueNumbers();
      }catch(e){
        alert("抽選に失敗しました: " + e.message);
        dbg("抽選失敗: " + e.message);
        return;
      }

      document.getElementById("result").textContent = nums.map(pad2).join("  ");
      const items = loadHistory();
      items.push({ ts: nowTimestamp(), nums });
      saveHistory(items);
      render();
    });

    document.getElementById("copy").addEventListener("click", async () => {
      const text = document.getElementById("result").textContent;
      if(text === "—") return alert("まだ抽選していません。");
      try{
        await navigator.clipboard.writeText(text.replace(/\s+/g, ", "));
        alert("コピーしました。");
      }catch{
        alert("コピーに失敗しました（ブラウザ制限の可能性）。");
      }
    });

    document.getElementById("export").addEventListener("click", () => {
      const items = loadHistory();
      if(items.length === 0) return alert("履歴がありません。");
      let csv = "timestamp,n1,n2,n3,n4,n5,n6\n";
      for(const it of items){
        csv += [it.ts, ...it.nums].join(",") + "\n";
      }
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "history.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("clear").addEventListener("click", () => {
      if(!confirm("履歴を消去します。よろしいですか？")) return;
      localStorage.removeItem(KEY);
      document.getElementById("result").textContent = "—";
      render();
    });

    render();
    loadLoto6Stats();
    dbg("起動完了");
  });
</script>
</body>
</html>
